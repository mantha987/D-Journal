<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home - D- Journal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
          font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
          background: linear-gradient(135deg,#e3eafc 0%, #fdf6f0 100%);
          margin: 0; min-height: 100vh; padding-bottom: 80px;
        }
        .header-bar {
          background: #fff;
          border-radius: 25px;
          margin: 22px auto 0 auto;
          max-width: 950px;
          box-shadow: 0 8px 28px rgba(52,152,219,0.09), 0 1.5px 8px rgba(0,0,0,0.07);
          padding: 24px 18px 18px 18px;
          display: flex;
          align-items: center;
          justify-content: flex-start;
          gap: 18px;
          position: relative;
        }
        .logo-icon {
          width: 50px; height: 50px; margin-right: 10px; flex-shrink: 0;
          display: inline-block;
        }
        .logo-text {
          text-align: left; color: #ff0000; font-size: 2.2em;
          font-family: 'Times New Roman', serif; font-weight: bold;
          margin-right: 50px; letter-spacing: 2px;
          text-shadow: 0 1px 8px rgba(255,0,0,0.10); display: inline-block; vertical-align: middle;
        }
        .menu-bar {
          margin-left: auto; position: relative;
        }
        .menu-icon {
          width: 38px; height: 38px; cursor: pointer; background: none; border: none; outline: none;
        }
        .menu-popup {
          display: none;
          position: absolute;
          top: 54px;
          right: 0;
          background: #fff;
          border-radius: 11px;
          box-shadow: 0 8px 28px rgba(52,152,219,0.11);
          padding: 10px 0;
          min-width: 210px;
          z-index: 10;
          animation: zoomInMenu 0.22s;
        }
        @keyframes zoomInMenu {
          from { transform: scale(0.8); opacity: 0;}
          to { transform: scale(1); opacity: 1;}
        }
        .menu-popup button {
          width: 100%;
          background: none;
          color: #3498db;
          border: none;
          padding: 14px 32px;
          font-size: 1.13em;
          font-weight: 600;
          text-align: left;
          cursor: pointer;
          transition: background 0.14s, color 0.14s;
          border-radius: 0;
          margin: 0;
        }
        .menu-popup button:hover {
          background: linear-gradient(90deg, #3498db 0%, #ff0000 90%);
          color: #fff;
        }
        .textbox-section { margin: 38px auto 0 auto; max-width: 820px; }
        .floating-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            background: #3498db;
            color: #fff;
            border: none;
            outline: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
        }
        .modal-bg {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.2);
            z-index: 99;
        }
        .modal {
            position: fixed;
            top: 50%; left: 50%;
            background: #fff;
            padding: 40px 40px 28px 40px;
            border-radius: 18px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.22);
            transform: translate(-50%, -50%);
            min-width: 420px;
            max-width: 98vw;
            min-height: 180px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .modal textarea {
            width: 100%; 
            min-width: 340px;
            max-width: 620px;
            min-height: 160px;
            max-height: 350px;
            font-size: 1.14em;
            margin-bottom: 22px;
            padding: 15px 16px;
            border-radius: 14px;
            border: 2px solid #e3eafc;
            background: linear-gradient(135deg,#f5f6fa 60%,#e3eafc 100%);
            outline: none;
            box-shadow: 0 1.5px 8px rgba(52,152,219,0.06);
            transition: border 0.2s, box-shadow 0.2s;
            resize: vertical;
        }
        .modal textarea:focus {
            border: 2px solid #3498db;
            background: #f8faff;
            box-shadow: 0 6px 18px rgba(52,152,219,0.12);
        }
        .modal .images-list { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .modal .img-thumb {
            width: 68px; height: 68px; object-fit: cover; border-radius: 8px; border: 1.5px solid #eee;
            box-shadow: 0 2px 8px rgba(52,152,219,0.06);
            cursor: pointer;
            transition: box-shadow 0.15s;
        }
        .modal .img-thumb:hover {
            box-shadow: 0 8px 24px rgba(52,152,219,0.22);
        }
        .modal input[type="file"] {
            margin-bottom: 18px;
            font-size: 1em;
        }
        .modal .close-btn, .modal .save-btn {
            background: linear-gradient(90deg,#2ecc71 80%,#3498db 120%);
            color: #fff; border: none; border-radius: 9px; font-size: 18px;
            padding: 12px 26px; margin-right: 16px; cursor: pointer;
            box-shadow: 0 1.5px 8px rgba(52,152,219,0.10);
            font-weight: 600;
            letter-spacing: 1px;
            transition: background 0.19s, box-shadow 0.15s;
        }
        .modal .close-btn { background: linear-gradient(90deg,#e74c3c 80%,#ff0000 120%);}
        .modal .save-btn { float: right; }
        .textbox-card {
            background: linear-gradient(135deg,#f8faff 70%, #fff 100%);
            box-shadow: 0 2px 18px rgba(52,152,219,0.08), 0 1.5px 8px rgba(0,0,0,0.06);
            border-radius: 17px;
            padding: 28px 32px;
            margin-bottom: 24px;
            cursor: pointer;
            transition: box-shadow 0.23s, transform 0.17s;
            border: 2px solid #e3eafc;
            position: relative;
        }
        .textbox-card:hover { 
            box-shadow: 0 12px 28px rgba(52,152,219,0.19);
            transform: scale(1.02);
            border-color: #3498db;
        }
        .textbox-title {
            font-weight: bold;
            font-size: 1.32em;
            margin-bottom: 9px;
            color: #3498db;
            letter-spacing: 1px;
        }
        .textbox-content {
            font-size: 1.16em;
            color: #444;
            margin-bottom: 13px;
            line-height: 1.7;
            word-break: break-word;
        }
        .textbox-images { display: flex; gap: 14px; margin-bottom: 11px;}
        .textbox-images img {
            max-width: 85px; max-height: 85px; border-radius: 8px; border: 1.5px solid #eee;
            box-shadow: 0 1px 6px rgba(52,152,219,0.09);
        }
        .textbox-meta {
            font-size: 1em;
            color: #888;
            position: absolute;
            bottom: 18px;
            right: 28px;
        }
    </style>
</head>
<body>
    <div class="header-bar">
      <!-- Dairy Icon SVG -->
      <span class="logo-icon">
        <svg viewBox="0 0 48 48" width="48" height="48" fill="none">
          <rect x="7" y="7" width="34" height="34" rx="8" fill="#fdf6f0" stroke="#3498db" stroke-width="2"/>
          <rect x="13" y="13" width="22" height="22" rx="5" fill="#fff" stroke="#ff0000" stroke-width="2"/>
          <path d="M17 18 h14 M17 22 h14 M17 26 h7" stroke="#3498db" stroke-width="2" stroke-linecap="round"/>
          <ellipse cx="33" cy="31" rx="2.2" ry="2.2" fill="#ffd700" stroke="#3498db" stroke-width="1"/>
        </svg>
      </span>
      <span class="logo-text">D- Journal</span>
      <div class="menu-bar">
        <button class="menu-icon" id="menuBtn" aria-label="Menu">
          <svg viewBox="0 0 24 24" width="38" height="38" fill="none">
            <rect y="4" width="24" height="3.5" rx="1.7" fill="#3498db"/>
            <rect y="10" width="24" height="3.5" rx="1.7" fill="#ff0000"/>
            <rect y="16" width="24" height="3.5" rx="1.7" fill="#3498db"/>
          </svg>
        </button>
        <div class="menu-popup" id="menuPopup">
          <button onclick="window.location.href='home.html'">Home</button>
          <button onclick="window.location.href='mood.html'">Mood Tracker</button>
          <button onclick="window.location.href='settings.html'">Settings</button>
          <button id="logoutBtn">Logout</button>
        </div>
      </div>
    </div>
    <div class="textbox-section" id="textboxSection"></div>
    <button class="floating-btn" id="openModalBtn">+</button>
    <div class="modal-bg" id="modalBg"></div>
    <div class="modal" id="modal" style="display:none;">
        <form id="modalForm">
            <textarea id="modalText" placeholder="Write your journal entry here. Express yourself freely..."></textarea>
            <div class="images-list" id="modalImages"></div>
            <input type="file" id="imageInput" accept="image/*" multiple>
            <br>
            <button type="button" class="close-btn" id="modalBackBtn">Back & Save</button>
            <button type="submit" class="save-btn" style="display:none;">Save</button>
        </form>
    </div>
    <script src="storage.js"></script>
    <script>
        // Menu popup logic
        const menuBtn = document.getElementById("menuBtn");
        const menuPopup = document.getElementById("menuPopup");
        menuBtn.onclick = function(e) {
          menuPopup.style.display = menuPopup.style.display === "block" ? "none" : "block";
          e.stopPropagation();
        };
        window.onclick = function() {
          menuPopup.style.display = "none";
        };
        menuPopup.onclick = function(e) { e.stopPropagation(); };

        let loggedInEmail = getLoggedInEmail();
        const user = loggedInEmail ? getUserByEmail(loggedInEmail) : null;
        if (!loggedInEmail || !user) {
            window.location.href = "index.html"; // Redirect to sign in
        }

        // Logout action in menu
        document.getElementById("logoutBtn").onclick = function() {
            removeLoggedInEmail();
            window.location.href = "index.html";
        };

        // Use a key for textboxes per user
        let textboxesKey = loggedInEmail ? 'textboxes-' + loggedInEmail : 'textboxes-anonymous';
        let textboxes = JSON.parse(localStorage.getItem(textboxesKey) || '[]');
        let editingIndex = null;
        const openModalBtn = document.getElementById('openModalBtn');
        const modal = document.getElementById('modal');
        const modalBg = document.getElementById('modalBg');
        const modalText = document.getElementById('modalText');
        const modalForm = document.getElementById('modalForm');
        const modalImages = document.getElementById('modalImages');
        const imageInput = document.getElementById('imageInput');
        const modalBackBtn = document.getElementById('modalBackBtn');
        const textboxSection = document.getElementById('textboxSection');

        function renderTextboxes() {
            textboxSection.innerHTML = '';
            // Sort by lastEdited descending (chronological)
            textboxes.sort((a, b) => b.lastEdited - a.lastEdited);
            textboxes.forEach((tb, idx) => {
                const div = document.createElement('div');
                div.className = 'textbox-card';
                div.onclick = () => openEditModal(idx);

                div.innerHTML = `
                    <div class="textbox-title">Textbox ${tb.number}</div>
                    <div class="textbox-content">${tb.text ? tb.text.replace(/\n/g,'<br>') : ''}</div>
                    <div class="textbox-images">
                        ${tb.images.map(img => `<img src="${img}" alt="Image">`).join('')}
                    </div>
                    <div class="textbox-meta">Last edited: ${formatTime(tb.lastEdited)}</div>
                `;
                textboxSection.appendChild(div);
            });
        }
        function formatTime(ts) {
            const date = new Date(ts);
            return date.toLocaleString();
        }
        function openModal(isEdit=false) {
            modal.style.display = '';
            modalBg.style.display = '';
            imageInput.value = '';
            modalImages.innerHTML = '';
            if(!isEdit) {
                modalText.value = '';
                modalImages.innerHTML = '';
                editingIndex = null;
            }
            document.body.style.overflow = 'hidden';
        }
        function closeModal() {
            modal.style.display = 'none';
            modalBg.style.display = 'none';
            document.body.style.overflow = '';
        }
        openModalBtn.onclick = () => openModal();
        modalBg.onclick = closeModal;

        imageInput.onchange = function(e) {
            const files = Array.from(e.target.files);
            for (let f of files) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.className = 'img-thumb';
                    img.onclick = () => img.remove();
                    modalImages.appendChild(img);
                };
                reader.readAsDataURL(f);
            }
        };

        // Save (on back button)
        modalBackBtn.onclick = function() {
            const text = modalText.value.trim();
            const images = Array.from(modalImages.children).map(img => img.src);
            if (editingIndex != null) {
                textboxes[editingIndex].text = text;
                textboxes[editingIndex].images = images;
                textboxes[editingIndex].lastEdited = Date.now();
            } else {
                const num = textboxes.length + 1;
                textboxes.push({
                    number: num,
                    text: text,
                    images: images,
                    lastEdited: Date.now()
                });
            }
            localStorage.setItem(textboxesKey, JSON.stringify(textboxes));
            renderTextboxes();
            closeModal();
        };

        // Open for editing
        function openEditModal(idx) {
            editingIndex = idx;
            const tb = textboxes[idx];
            modalText.value = tb.text;
            modalImages.innerHTML = '';
            tb.images.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'img-thumb';
                img.onclick = () => img.remove();
                modalImages.appendChild(img);
            });
            openModal(true);
        }

        // Prevent default form submit
        modalForm.onsubmit = e => e.preventDefault();

        // Show real-time last edited (on edit)
        modalText.oninput = () => {
            if (editingIndex != null) {
                textboxes[editingIndex].lastEdited = Date.now();
                renderTextboxes();
            }
        };

        renderTextboxes();
    </script>
</body>
</html>